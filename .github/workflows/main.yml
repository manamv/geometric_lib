name: Geometric Library CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  format-and-lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install formatting tools
      run: |
        python -m pip install --upgrade pip
        pip install black flake8
    
    - name: Auto-format with black
      run: |
        echo "Auto-formatting Python files..."
        black *.py tests/*.py --verbose
    
    - name: Check code style (light)
      run: |
        echo "Checking code style (ignoring whitespace issues)..."
        flake8 *.py tests/*.py --ignore=E111,E114,W291,W293 --max-line-length=100
        echo "Code style check passed"
    
    - name: Validate Python syntax
      run: |
        echo "Validating Python syntax..."
        for file in rectangle.py square.py triangle.py circle.py; do
          python -m py_compile "$file"
        done
        echo "All files have valid syntax"

  unit-tests:
    name: Run Unit Tests
    needs: format-and-lint
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Display environment info
      run: |
        echo "Running on: ${{ runner.os }}"
        python --version
    
    - name: Run all unit tests
      run: |
        python -m unittest discover -s tests -p "test_*.py" -v
    
    - name: Run individual module tests
      run: |
        echo "Testing rectangle module..."
        python -m unittest tests.test_rectangle -v
        echo "Testing square module..."
        python -m unittest tests.test_square -v
        echo "Testing triangle module..."
        python -m unittest tests.test_triangle -v
        echo "Testing circle module..."
        python -m unittest tests.test_circle -v

  documentation:
    name: Generate Documentation
    needs: unit-tests
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install pdoc
      run: pip install pdoc
    
    - name: Generate HTML documentation
      run: |
        echo "Generating documentation..."
        python -m pdoc --html -o docs/ .
        echo "Documentation generated"
    
    - name: List generated files
      run: |
        find docs/ -type f -name "*.html" | head -10
    
    - name: Upload documentation artifact
      uses: actions/upload-artifact@v3
      with:
        name: geometric-library-docs
        path: docs/
        retention-days: 7
